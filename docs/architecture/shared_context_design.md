# 共有コンテキスト機能 設計書

## 概要

タスク間でコードベースを共有し、import問題を解決するための共有コンテキスト機能の設計。

## 要件

### 機能要件

1. **共有ワークスペース**
   - 全タスクが参照可能な共有コードベース
   - タスクの成果物を段階的に統合

2. **並列実行の安全性**
   - 同時書き込みによるファイル破損の防止
   - Copy-on-Write方式による分離

3. **インテリジェントな統合**
   - 3-wayマージによる競合解決
   - Claude Codeを使用した意味的マージ

4. **後方互換性**
   - 既存プロジェクトは影響を受けない
   - オプトイン方式で有効化

### 非機能要件

1. **パフォーマンス**
   - ワークスペースのコピーは最小限
   - 差分検出は効率的に

2. **信頼性**
   - 失敗時のロールバック
   - データ破損の防止

## アーキテクチャ

### データフロー

```
1. タスク開始時
   shared_workspace → [COPY] → task_workspace
   
2. タスク実行中
   task_workspace ← [Claude Code] → 変更
   
3. タスク完了時
   task_workspace → [DIFF] → changes → [MERGE] → shared_workspace
```

### コンポーネント構成

```
ArtifactManager（拡張）
├── スナップショット管理
├── 差分検出
├── ワークスペース準備
└── 統合処理
    └── ConflictResolver（3-wayマージ）

TaskExecutor（改修）
└── 共有ワークスペースからの初期化

Orchestrator（改修）
└── 統合フローの制御
```

## 実装詳細

### 1. スナップショット管理

```python
Snapshot = Dict[str, FileMetadata]
FileMetadata = {
    "hash": str,      # SHA-256ハッシュ
    "size": int,      # ファイルサイズ
    "mtime": float    # 最終更新時刻
}
```

### 2. 差分検出アルゴリズム

```python
Changes = {
    "new": List[str],      # 新規作成されたファイル
    "deleted": List[str],  # 削除されたファイル
    "modified": List[str]  # 変更されたファイル
}
```

### 3. 3-wayマージ

```
Base (コピー時点) + Shared (現在の共有) + Task (タスク結果)
                    ↓
                 Merged (統合結果)
```

### 4. 競合解決戦略

1. **自動解決可能**
   - 片方のみ変更: その変更を採用
   - 新規ファイル: 追加
   - 異なるファイル: 両方維持

2. **Claude Code解決**
   - 同一ファイルの変更: 意味的マージ
   - import文の統合
   - 関数の統合

3. **解決不可**
   - バージョンサフィックス付与
   - 警告ログ出力

## 設定

```yaml
# project.yaml
execution:
  shared_context: true  # 共有コンテキストを有効化
  merge_strategy: "intelligent"  # マージ戦略
```

## 移行計画

### Phase 1: 基盤実装
- スナップショット機能
- 差分検出機能

### Phase 2: 統合実装
- ワークスペース管理
- 基本的なマージ

### Phase 3: 高度な機能
- インテリジェントマージ
- パフォーマンス最適化

## リスクと対策

### リスク1: ワークスペースコピーのオーバーヘッド
**対策**: 
- ハードリンクの使用検討
- 差分コピーの実装

### リスク2: 複雑な競合の解決失敗
**対策**:
- 段階的なマージ戦略
- 人間による確認オプション

### リスク3: 並列実行時の一貫性
**対策**:
- アトミックな統合処理
- ロック機構の実装

## テスト戦略

1. **単体テスト**
   - スナップショット作成/比較
   - 差分検出の正確性
   - マージロジック

2. **統合テスト**
   - 並列タスクの競合シナリオ
   - 大規模プロジェクトでの性能

3. **E2Eテスト**
   - 実際のプロジェクトでの動作確認